services:
- docker
env:
  global:
  - DOCKER_COMPOSE_VERSION=1.29.2
  - secure: "mAPMOlBid7dZJLHo1KgqNmk2n2w8YmSDKJSGZOGr1LXftGiTeTx7UDJYCsj6Aml1nxlRqNjHr6qAPtmca6mPIsr9JQIBpN9FqdiSeU5Ex46IcPj5IYqUClEbAE1kF4kjqzh5tt1hj2UXyCAKWu7couc0uPBFBn4CvX/tycPY/WSdbm0OVgjg2E4clDnw6RWGnjzc5HX1GOA7R8mlgWUaMqhRPc9UkDA6qrrF04+nV8KArJsrHl+DTQ0magUpRDVgUNt/58gchJN+RnF7FNM5Pf1lXZ4LjkIxJL1TD0hX8UPp95ognrCSl6OJEzALuHrbd3KCwcb8nfuVcGWHvD2GOVDOK2nqwh6jJRhCXssAnFuuPtoAoRTBS06R3ZRwUsqyl5qsfXjiHnOsdkhRzTUjRY5UvOLFc6fPJ6TX11Fq0AIyjsXPFCaw8lXU8t1wbyPGW7M1ifMTgqQE56pURZBYnEyWfEvwi6SKlHj58RwDPsB5qetOa43UfNbPHa2bpPVPV4G3LkWwcFiSFYkoZEPks02h2btrqokYsslkaGY53bq7uDbsnocXtnn0RMGaz8pQarB+IOjaV2qbBG9Y0+n5xulOnra6cWHxWOKxdyWHJO4LRkSCSoCGvh5rex6bvSxa7ofFcgI5Arsz1otSdGMRKRrma69sk+ahEnT8CQaDxsE="
  - secure: "n2RTuM7qg2FJ1OC4RdnrHBUQ3bheiSunkWohjpCATLtRm4DacJ+WtERSVeOWhJ6yrORCLuhN1HnfHYHU2RbIvSj1Ahh/ZLP1nE5tFdYHjEk/ctFR3D9iFKoZS5VqcN7TFC5jhbVG2HPoftL/dq57ZIFaomSuquAqKEUMf0xOG7twZNaWWfBp1NLw9SbSS2xZhtPOm++bAMbm6I7t2noA9oyeEaPIlVIl4t4R31Sv9CCxbCxcZ1Wi394W+87LVzK3iuGuJu7D6tpkGePC9MxOc/Wv12w01n0wbPb8poHO6axfkP8yoSAfY5rptVzjkszPz1YfXhbGSAxNNYcvcYb1ALeh0mnZqWDKMRN97BDF3i42M/Y6IhTF/GIAfdxf0GFb4WSfGmBfFh7ciEinPUaKdkrt7zKb9LsGy2YJhiluF5p8J4RUxbuKs+p1oyCA9kH77ffxEjQVSeZC0h88Lt5tHLL+WF2gP5lJ7Ktd7UznNM0K3I2uJflCB7nFUukmx8dK0VDmv7vWFZOTq31jJnenIG2wKuEJksEgUoXER9RB7nE1OfZO+PH23YcmWStU9b0JoV7F/d3B+NYh2LW0vhrAQ/qtrNG9wWafK/IrAS6PfPcC1zjZwyA+jgkbNnPrW6uyPJOXKIMEbXsDKvgDCO6FVhbS2Eqy0VeOGmyqseIgMwk="

before_install:
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname
  -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin
- docker --version
- docker-compose version
- echo "Login into Docker Hub"
- echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
- export GIT_SHA=`git rev-parse --short HEAD`
- echo "Building commit $GIT_SHA"
jobs:
  include:
  - stage: tests
    name: Unit Tests
    script:
    - cd Chapter04
    - docker-compose build db
    - docker-compose build test-postgresql
    - docker-compose run test-postgresql
  - stage: tests
    name: Static Analysis
    script:
    - cd Chapter04
    - docker-compose build static-analysis
    - docker-compose run static-analysis
  - stage: push
    script:
    - cd Chapter04
    - docker-compose build server
    - docker tag thoughts_server:latest renanvicente/thoughts-backend:$GIT_SHA
    - docker push renanvicente/thoughts-backend:$GIT_SHA
    - docker tag thoughts_server:latest renanvicente/thoughts-backend:$TRAVIS_BRANCH
    deploy:
    - provider: script
      script: docker push renanvicente/thoughts-backend:$TRAVIS_BRANCH
      on:
        branch: master
    - provider: script
      script: docker push renanvicente/thoughts-backend:$TRAVIS_TAG
      on:
        tags: true
